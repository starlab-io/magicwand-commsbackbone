FROM patricknevindwyer/pin-ubuntu64-trusty:latest
MAINTAINER patricknevindwyer@gmail.com

# Already includes a PIN enabled 64bit Apache 2.2.11

USER root

RUN apt-get update
RUN apt-get install -y g++ wget gcc make python gnuplot autopoint gettext autoconf libtool automake pkg-config

# install VMSTAT
RUN wget https://gitlab.com/procps-ng/procps/repository/archive.tar.gz?ref=v3.3.11 -O procps-ng.tar.gz
RUN tar -xvf procps-ng.tar.gz
RUN mv procps-v* procps
WORKDIR procps
RUN ./autogen.sh
RUN ./configure --without-ncurses
RUN make
RUN mv vmstat /usr/bin/vmstat

COPY httpd-foreground /usr/local/bin
COPY httpd-background /usr/local/bin
COPY start-pinned-apache.sh /usr/local/bin
COPY startscript.sh /usr/local/bin
COPY parse_apacheperf.py /usr/local/bin
COPY expand.sh /usr/local/bin
COPY performance_plot.gp /usr/local/src
RUN chmod ugo+x /usr/local/bin/startscript.sh
RUN chmod ugo+x /usr/local/bin/expand.sh
RUN chmod ugo+x /usr/local/bin/parse_apacheperf.py
RUN chmod ugo+x /usr/local/bin/httpd-foreground
RUN chmod ugo+x /usr/local/bin/httpd-background
RUN chmod ugo+x /usr/local/bin/start-pinned-apache.sh

#cgi:
COPY cgiDatPy /usr/local/apache2/cgi-bin
RUN chmod 555 /usr/local/apache2/cgi-bin/cgiDatPy

ENV PATH $PATH:/httpd-2.2.11

EXPOSE 80

VOLUME ["/var/log/apacheperf", "/root/output"]

CMD ["start-pinned-apache.sh"]